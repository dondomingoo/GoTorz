# Stage 1: Build
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copy solution and all source folders
COPY . .

# Restore dependencies
RUN dotnet restore

# Copy all source code
COPY src/GoTorz.Api/ GoTorz.Api/
COPY src/GoTorz.Client/ GoTorz.Client/
COPY src/GoTorz.Shared/ GoTorz.Shared/

# Publish the Client project
WORKDIR /src/GoTorz.Client
RUN dotnet publish -c Release -o /app/publish

# Stage 2: Runtime
FROM nginx:stable-alpine AS runtime
WORKDIR /usr/share/nginx/html

# Remove default nginx static content
RUN rm -rf ./*

# Copy Blazor build output
COPY --from=build /app/publish/wwwroot .

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
