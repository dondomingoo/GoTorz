# Stage 1: Build
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copy solution and all source folders
COPY . .

# Inject the actual API base URL into the Blazor WASM Program.cs
ARG API_BASE_URL
RUN sed -i "s|__API_BASE_URL__|${API_BASE_URL}|" ./src/GoTorz.Client/Program.cs

# Restore dependencies
RUN dotnet restore

# Publish the Client project
WORKDIR /src/GoTorz.Client
RUN dotnet publish -c Release -o /app/publish

# Stage 2: Runtime
FROM nginx:stable-alpine AS runtime
WORKDIR /usr/share/nginx/html

# Remove default nginx static content
RUN rm -rf ./*

# Copy Blazor build output
COPY --from=build /app/publish/wwwroot .

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
